---
import "../styles/projects.css";
import Layout from "../layouts/Layout.astro";
import Hero from "../components/commons/hero/hero.astro";
import Banner from "../components/commons/banners/banner.astro";
import { proyectos } from "../data/projectData.js";
---

<Layout title="Proyectos" description="Proyectos">
  <Hero titulo="Proyectos" />

  <!-- Botones -->
  <div class="mt-6 mb-6 flex flex-wrap justify-center gap-3 px-2">
    <button class="filter-btn cursor-pointer rounded-full bg-[#69c7c7] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#7836cf] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="all">
      Todos
    </button>
    <button class="filter-btn cursor-pointer rounded-full bg-[#69c7c7] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#7836cf] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="ia">
      IA & NLP
    </button>
    <button class="filter-btn cursor-pointer rounded-full bg-[#69c7c7] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#7836cf] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="ds">
      Data Science
    </button>
    <button class="filter-btn cursor-pointer rounded-full bg-[#69c7c7] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#7836cf] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="mlops">
      MLOps
    </button>
    <button class="filter-btn cursor-pointer rounded-full bg-[#69c7c7] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#7836cf] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="software">
      Software
    </button>
  </div>

  <!-- Listado de Proyectos -->
  <div
    id="projects-container"
    class="site-container mt-10 space-y-10 mx-auto max-w-6xl px-4"
  >
    {
      proyectos.map((proyecto, index) => (
        <div 
          data-index={index}
          data-categoria={proyecto.categoria ?? ""}
          class="project-item bg-gray-900 p-6 rounded-2xl shadow-lg drop-shadow-[4px_4px_0_#7836cf] flex flex-col md:flex-row gap-8 items-center md:items-start transition-all duration-300"
        >
          <!-- Imagen a la izquierda -->
          <div class="w-full md:w-64 h-48 flex-shrink-0 bg-gray-800 rounded-xl overflow-hidden border-2 border-[#7836cf]">
            <img
              src={proyecto.imagen}
              alt={`Imagen de ${proyecto.titulo}`}
              class="w-full h-full object-cover"
            />
          </div>

          <!-- Contenido a la derecha -->
          <div class="flex-grow w-full">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-2">
              <h3 class="text-2xl font-bold text-[#69c7c7]">{proyecto.titulo}</h3>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
              {proyecto.tecnologias.map((tech) => (
                <span class="rounded-md bg-[#7836cf]/20 text-[#a27ed1] px-2 py-0.5 text-xs font-semibold">
                  {tech}
                </span>
              ))}
            </div>

            <p class="text-gray-300 mb-4 font-semibold">{proyecto.descripcion}</p>

            {proyecto.details && (
              <ul class="marker:text-[#7836cf] list-disc space-y-2 pl-5 text-gray-300 mb-4">
                {proyecto.details.map((item) => (
                  <li>{item}</li>
                ))}
              </ul>
            )}
            
            <div class="flex gap-4 mt-auto">
              {proyecto.codigo && (
                <a 
                  href={proyecto.codigo} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-1 text-[#69c7c7] font-bold hover:underline"
                >
                  Ver Código
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                  </svg>
                </a>
              )}
            </div>
          </div>
        </div>
      ))
    }
  </div>

  <!-- Ver el resto de los proyectos -->
  <div class="flex justify-center mt-8">
    <button
      id="load-more"
      class="px-6 py-2 cursor-pointer bg-[#69c7c7] text-[#1d1250] font-bold rounded-full hover:bg-[#46caca] drop-shadow-[2px_2px_0_#7836cf] active:translate-y-0.5 active:drop-shadow-none transition-all"
    >
      Ver más
    </button>
  </div>

  <Banner />
</Layout>

<script is:inline>
(function () {
  /* ---------------- CONFIG ---------------- */
  const VISIBLE_CLASS = "project-visible";
  const HIDDEN_CLASS = "project-hidden";
  const HIDE_TIMEOUT = 300;

  const INITIAL_VISIBLE = 12;
  let itemsToShow = INITIAL_VISIBLE;
  let activeFilter = "all";
  let cards = [];
  let filterButtons = [];
  let loadMoreBtn = null;

  /* ---------------- HELPERS ---------------- */
  function queryElements() {
    cards = Array.from(document.querySelectorAll("[data-index]"));
    filterButtons = Array.from(document.querySelectorAll(".filter-btn"));
    loadMoreBtn = document.getElementById("load-more");
  }

  function showCard(card) {
    card.style.display = "flex";
    requestAnimationFrame(() => {
      card.classList.remove(HIDDEN_CLASS);
      card.classList.add(VISIBLE_CLASS);
    });
  }

  function hideCard(card) {
    card.classList.remove(VISIBLE_CLASS);
    card.classList.add(HIDDEN_CLASS);
    setTimeout(() => {
      if (card.classList.contains(HIDDEN_CLASS)) {
        card.style.display = "none";
      }
    }, HIDE_TIMEOUT);
  }

  function setActiveButton(btn) {
    filterButtons.forEach((b) => b.classList.remove("active"));
    if (btn) btn.classList.add("active");
  }

  /* ---------------- FILTRADO ---------------- */
  function applyFilter(filter) {
    activeFilter = filter ?? "all";
    const normalized = activeFilter.toLowerCase();

    cards = Array.from(document.querySelectorAll("[data-index]"));

    const filteredCards = cards.filter((card) => {
      const categoria = (card.dataset.categoria ?? "").toLowerCase();
      return normalized === "all" || categoria === normalized;
    });

    cards.forEach((c) => hideCard(c));

    filteredCards.forEach((card, i) => {
      if (i < itemsToShow) showCard(card);
    });

    // botón ver más visible solo si hay más para ver
    if (!loadMoreBtn) return;
    loadMoreBtn.style.display = filteredCards.length > itemsToShow ? "block" : "none";
  }

  /* ---------------- Filtros eventos ---------------- */
  function attachFilterEvents() {
    if (!filterButtons.length) return;
    filterButtons.forEach((btn) => {
      btn.onclick = () => {
        itemsToShow = INITIAL_VISIBLE; 
        const filter = btn.dataset.filter || "all";
        setActiveButton(btn);
        applyFilter(filter);
      };
    });

    // activar "Todos" al inicio
    const allBtn = document.querySelector('.filter-btn[data-filter="all"]');
    setActiveButton(allBtn);
  }

  /* ---------------- Ver mas ---------------- */
  function attachLoadMore() {
    if (!loadMoreBtn) return;
    loadMoreBtn.onclick = () => {
      itemsToShow += INITIAL_VISIBLE; 
      applyFilter(activeFilter); 
    };
  }

  /* ---------------- INIT ---------------- */
  function init() {
    queryElements();
    attachFilterEvents();
    attachLoadMore();
    applyFilter("all");
  }

  document.addEventListener("astro:page-load", init);
  window.addEventListener("load", init);
})();
</script>
