---
import "../styles/projects.css"; // Reusing project styles for consistency
import Layout from "../layouts/Layout.astro";
import Hero from "../components/commons/hero/hero.astro";
import Banner from "../components/commons/banners/banner.astro";
import { jobs } from "../data/jobsData.js";

// Cálculo de experiencia total
let totalMonths = 0;
jobs.forEach(job => {
  const timeStr = job.time[0];
  const [startStr, endStr] = timeStr.split(" - ");

  const parseDate = (str) => {
    if (str.toLowerCase() === "actualidad") return new Date();
    const [month, year] = str.split("/");
    return new Date(parseInt(year), parseInt(month) - 1);
  };

  const startDate = parseDate(startStr);
  const endDate = parseDate(endStr);

  let months = (endDate.getFullYear() - startDate.getFullYear()) * 12;
  months -= startDate.getMonth();
  months += endDate.getMonth();
  
  totalMonths += (months + 1);
});

const years = Math.floor(totalMonths / 12);
const remainingMonths = totalMonths % 12;

let experienceString = "";
if (years > 0) {
  experienceString += `${years} ${years === 1 ? "año" : "años"}`;
}
if (remainingMonths > 0) {
  if (years > 0) experienceString += " y ";
  experienceString += `${remainingMonths} ${remainingMonths === 1 ? "mes" : "meses"}`;
}
---

<Layout title="Experiencia" description="Mi experiencia laboral">
  <Hero titulo="Experiencia" />

  <!-- Contador de Experiencia -->
  <div class="text-center mt-8 mb-4">
    <p class="text-xl text-gray-300 font-medium">
      Experiencia Total: <span class="text-[#69c7c7] font-bold text-2xl">{experienceString}</span>
    </p>
  </div>

  <!-- Botones -->
  <div class="mt-6 mb-6 flex flex-wrap justify-center gap-3 px-2">
    <button class="exp-filter-btn cursor-pointer rounded-full bg-[#69c7c7] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#7836cf] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="all">
      Todos
    </button>
    <button class="exp-filter-btn cursor-pointer rounded-full bg-[#69c7c7] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#7836cf] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="ia">
      IA & NLP
    </button>
    <button class="exp-filter-btn cursor-pointer rounded-full bg-[#69c7c7] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#7836cf] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="ds">
      Data Science
    </button>
  </div>

  <!-- Listado de Experiencia -->
  <div
    id="experience-container"
    class="site-container mt-10 space-y-10 mx-auto max-w-6xl px-4"
  >
    {
      jobs.map((job, index) => {
        const parts = job.title.split(" - ");
        const company = parts.pop();
        const role = parts.join(" - ");

        return (
        <div 
          data-index={index}
          data-categoria={job.categoria ?? ""}
          class="experience-item bg-gray-900 p-6 rounded-2xl shadow-lg drop-shadow-[4px_4px_0_#7836cf] flex flex-col md:flex-row gap-8 items-center md:items-start transition-all duration-300"
        >
          <!-- Imagen a la izquierda -->
          <div class="w-32 h-32 flex-shrink-0 bg-white rounded-xl p-4 flex items-center justify-center">
            <img
              src={job.imagen}
              alt={`Logo de ${company}`}
              class="max-h-full max-w-full object-contain"
            />
          </div>

          <!-- Contenido a la derecha -->
          <div class="flex-grow">
            <div class="flex flex-col md:flex-row md:justify-between md:items-start mb-2">
              <div class="flex flex-col">
                <h3 class="text-2xl font-bold text-[#69c7c7] leading-tight">{role}</h3>
                <span class="text-lg font-semibold text-[#a27ed1] mt-1">{company}</span>
              </div>
              <span class="text-gray-400 font-semibold mt-2 md:mt-0 text-right min-w-fit">{job.time.join(" - ")}</span>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
              {job.tecnologias.map((tech) => (
                <span class="rounded-md bg-[#7836cf]/20 text-[#a27ed1] px-2 py-0.5 text-xs font-semibold">
                  {tech}
                </span>
              ))}
            </div>

            <p class="text-gray-300 mb-4">{job.description}</p>

            <ul class="marker:text-[#7836cf] list-disc space-y-2 pl-5 text-gray-300">
              {job.list.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        </div>
      );
    })}
  </div>

  <div class="flex justify-center mt-8">
    <button
      id="load-more-exp"
      class="px-6 py-2 cursor-pointer bg-[#69c7c7] text-[#1d1250] font-bold rounded-full hover:bg-[#46caca] drop-shadow-[2px_2px_0_#7836cf] active:translate-y-0.5 active:drop-shadow-none transition-all"
    >
      Ver más
    </button>
  </div>

  <Banner />
</Layout>

<script is:inline>
(function () {
  /* ---------------- CONFIG ---------------- */
  const VISIBLE_CLASS = "project-visible";
  const HIDDEN_CLASS = "project-hidden";
  const HIDE_TIMEOUT = 300;

  const INITIAL_VISIBLE = 5; // Adjusted for list items
  let itemsToShow = INITIAL_VISIBLE;
  let activeFilter = "all";
  let items = [];
  let filterButtons = [];
  let loadMoreBtn = null;

  /* ---------------- HELPERS ---------------- */
  function queryElements() {
    items = Array.from(document.querySelectorAll(".experience-item"));
    filterButtons = Array.from(document.querySelectorAll(".exp-filter-btn"));
    loadMoreBtn = document.getElementById("load-more-exp");
  }

  function showItem(item) {
    item.style.display = "flex";
    requestAnimationFrame(() => {
      item.classList.remove(HIDDEN_CLASS);
      item.classList.add(VISIBLE_CLASS);
    });
  }

  function hideItem(item) {
    item.classList.remove(VISIBLE_CLASS);
    item.classList.add(HIDDEN_CLASS);
    setTimeout(() => {
      if (item.classList.contains(HIDDEN_CLASS)) {
        item.style.display = "none";
      }
    }, HIDE_TIMEOUT);
  }

  function setActiveButton(btn) {
    filterButtons.forEach((b) => b.classList.remove("active"));
    if (btn) btn.classList.add("active");
  }

  /* ---------------- FILTRADO ---------------- */
  function applyFilter(filter) {
    activeFilter = filter ?? "all";
    const normalized = activeFilter.toLowerCase();

    items = Array.from(document.querySelectorAll(".experience-item"));

    const filteredItems = items.filter((item) => {
      const categoria = (item.dataset.categoria ?? "").toLowerCase();
      return normalized === "all" || categoria === normalized;
    });

    items.forEach((c) => hideItem(c));

    filteredItems.forEach((item, i) => {
      if (i < itemsToShow) showItem(item);
    });

    // botón ver más visible solo si hay más para ver
    if (!loadMoreBtn) return;
    loadMoreBtn.style.display = filteredItems.length > itemsToShow ? "block" : "none";
  }

  /* ---------------- Filtros eventos ---------------- */
  function attachFilterEvents() {
    if (!filterButtons.length) return;
    filterButtons.forEach((btn) => {
      btn.onclick = () => {
        itemsToShow = INITIAL_VISIBLE; 
        const filter = btn.dataset.filter || "all";
        setActiveButton(btn);
        applyFilter(filter);
      };
    });

    // activar "Todos" al inicio
    const allBtn = document.querySelector('.exp-filter-btn[data-filter="all"]');
    setActiveButton(allBtn);
  }

  /* ---------------- Ver mas ---------------- */
  function attachLoadMore() {
    if (!loadMoreBtn) return;
    loadMoreBtn.onclick = () => {
      itemsToShow += INITIAL_VISIBLE; 
      applyFilter(activeFilter); 
    };
  }

  /* ---------------- INIT ---------------- */
  function init() {
    queryElements();
    attachFilterEvents();
    attachLoadMore();
    applyFilter("all");
  }

  document.addEventListener("astro:page-load", init);
  window.addEventListener("load", init);
})();
</script>
